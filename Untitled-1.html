
<!DOCTYPE html>
<html lang="zh-cn">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="format-detection" content="telephone=no" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<meta content="telephone=no" name="format-detection" />
	<title>微信话费充值券</title>
	<link rel="stylesheet" type="text/css" href="//static.gtimg.com/vd/chong/v2/wx/wx_card/css/coupon_index.css" />
	<script type="text/javascript">
		function reportBase(extData, func) {
    var info = clientCheck(navigator.userAgent, window.screen.width, window.screen.height);
    var reportMsg = ['platform=' + info[0], 'browser=' + info[1], 'screen=' + info[2]];
    if (extData && extData.length > 0) {
        reportMsg = reportMsg.concat(extData);
    }
    reportDC(reportMsg.join('&'), func);
}

function clientCheck(ua, width, height) {
    var winScreen = ',320x355,320x480,320x408,320x568,480x800,480x854,540x960,720x1280,1080x1920,';
    var w = Math.min(width, height);
    var h = Math.max(width, height);
    var resolution = w + 'x' + h;
    if (winScreen.indexOf(resolution) == -1) {
        resolution = 'other';
    }
    var queue = ['winm', 'yunos', 'win', 'android', 'ios', 'linux'];
    var reg = {
        android: /An?dro?i?d?[^\d]*([\d\.])[\d\.]*/,
        ios: /OS ([X|\d])[\_\d]{0,2}/,
        win: /Windows NT (\d[\.\d]*)/,
        linux: /Linux (x86)/i,
        yunos: /(YunOs)/i,
        winm: /Windows(Mobile)/i,
        nokia: /(Nokia)/i
    }
    var platform = '';
    for (var p = 0; p < queue.length; p++) {
        var i = queue[p];
        var m = ua.match(reg[i]);
        if (m) {
            var k = m[1];
            if (i == 'android') {
                if (k != 4 && k != 2) {
                    platform = 'android-o';
                } else {
                    platform = 'android-' + k;
                }
            } else if (i == 'ios') {
                if (k != 6 || k == 7) {
                    platform = 'ios-o';
                } else {
                    platform = 'ios-' + k;
                }
            } else {
                k = k.toLowerCase();
                platform = i;
            }
        }
    }
    if (/android unknow/i.test(ua)) {
        platform = 'android-o';
    }
    platform = platform ? platform : 'other';
    var browser = '';
    var queue = ['uc', 'qq', 'wx', 'miui', 'chrome'];
    var reg = {
        uc: /UCBrowser\/(\d+)/i,
        qq: /MQQBrowser\/(\d)/i,
        miui: /MiuiBrowser\/(\d[\d\.]+)/i,
        chrome: /Chrome/i,
        wx: /MicroMessenger\/(\d)/i
    }
    for (var p = 0; p < queue.length; p++) {
        var i = queue[p];
        var m = ua.match(reg[i]);
        if (m) {
            browser = i;
        }
    }
    if (!browser) {
        if (platform == 'ios') {
            browser = 'safari-ios';
        } else if (platform == 'android' && /safari/i.test(ua)) {
            browser = 'safari-adr';
        } else if (platform == 'android' && /Browser\//i.test(ua)) {
            browser = 'android';
        } else if (platform == 'android') {
            browser = 'android';
        } else {
            browser = 'other';
        }
    }
    return [platform, browser, resolution];
}

function loadScript(o, func) {
    o.element = o.element || 'script';
    var el = document.createElement(o.element);
    el.charset = o.charset || 'utf-8';
    o.onBeforeSend && o.onBeforeSend(el);
    el.onload = el.onreadystatechange = function() {
        func && func();
        if (/loaded|complete/i.test(this.readyState) || navigator.userAgent.toLowerCase().indexOf("msie") == -1) {
            o.onLoad && o.onLoad();
            clear();
        }
    };
    el.onerror = function() {
        clear();
    };
    el.src = o.url;
    document.getElementsByTagName('head')[0].appendChild(el);

    function clear() {
        if (!el) {
            return;
        }
        el.onload = el.onreadystatechange = el.onerror = null;
        el.parentNode && (el.parentNode.removeChild(el));
        el = null;
    }
}

function reportDC(msg, func) {
    loadScript({
        url: "/php/index.php?d=m&c=dataCollector&m=report&" + msg + "&t=" + Math.random()
    }, func);
}

function $getQuery(name,url){
//参数：变量名，url为空则表从当前页面的url中取
	var u  = arguments[1] || window.location.search,
		reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)"),
		r = u.substr(u.indexOf("\?")+1).match(reg);
	return r!=null?r[2]:"";
}

function $setCookie(name, value, expires, path, domain, secure) {
	//写入COOKIES
	var exp = new Date(), expires = arguments[2] || null, path = arguments[3] || "/", domain = arguments[4] || null, secure = arguments[5] || false;
	expires ? exp.setMinutes(exp.getMinutes() + parseInt(expires)) : "";
	document.cookie = name + '=' + escape(value) + ( expires ? ';expires=' + exp.toGMTString() : '') + ( path ? ';path=' + path : '') + ( domain ? ';domain=' + domain : '') + ( secure ? ';secure' : '');
}

function $getCookie(name) {
	//读取COOKIE
	var reg = new RegExp("(^| )" + name + "(?:=([^;]*))?(;|$)"), val = document.cookie.match(reg);
	return val ? (val[2] ? unescape(val[2]) : "") : null;
}

function closeWindow(){
	if(typeof WeixinJSBridge!=="undefined"){
		WeixinJSBridge&&WeixinJSBridge.invoke('closeWindow',{},function(res){
		    //alert(res.err_msg);
		});
	}
}

function configTimeline(title,img,link,callback){
    onBridgeReady.push(function(){
        WeixinJSBridge.on('menu:share:timeline',function(){
            WeixinJSBridge.invoke('shareTimeline',{
                    "appid" : "",
                    "img_url":img,
                    "img_width": "108",
                    "img_height": "108",
                    "link": link,
                    "desc": title,
                    "title": title
                },function(res){
                    callback(res);
                }
            );
            return false;
        });
    });
}
function configMessage(title,message,img,link,callback){
    onBridgeReady.push(function(){
        WeixinJSBridge.on('menu:share:appmessage',function(){
            var ret=WeixinJSBridge.invoke('sendAppMessage',{
                "appid" : "",
                "img_url":img,
                "img_width": "108",
                "img_height": "108",
                "link": link,
                "desc": message,
                "title": title
            },function(res){
                callback(res);
            });
            return false;
        });
    });
}

function jumpWCMall(callback){
    callback = callback || function (res) {};
    WeixinJSBridge&&WeixinJSBridge.invoke('jumpWCMall', {
        "appid": "wx47031447c8352579", //公众号名称，由商户传⼊入，原生话费为wx47031447c8352579
        "funcId": "502318" //商品编号，原生话费为502318
    }, callback);
}

function goLogin(appid,url){
	var url=url||location.href.replace(/[?|&]code=[^&]*/g,'').replace(/#.*/,'');
	appid=appid||$getQuery('appid');
    document.cookie.split('; ').forEach(function(single){
        var key=single.split('=')[0];
        clearCookie(key);
    });
    
	location.href='//open.weixin.qq.com/connect/oauth2/authorize?appid='+appid+'&redirect_uri='+encodeURIComponent(url)+'&response_type=code&scope=snsapi_base&state=qqchongzhi#wechat_redirect';
}

function clearCookie(key){
    $setCookie(key,'deleted',-1,'/','chong.qq.com');
    $setCookie(key,'deleted',-1,'/','.chong.qq.com');
    $setCookie(key,'deleted',-1,'/','s.chong.qq.com');
    $setCookie(key,'deleted',-1,'/','.s.chong.qq.com');
    $setCookie(key,'deleted',-1);
}
function hideOption(){
    onBridgeReady.push(function(){
        WeixinJSBridge.call('hideOptionMenu');
    });
}

function showOption(){
    onBridgeReady.push(function(){
        WeixinJSBridge.call('showOptionMenu');
    });
}

function hideKeyBoard(){
    var inputs=[].slice.call(document.querySelectorAll('input'));
    inputs.forEach(function(item){
        item.setAttribute('readonly','true');
        item.setAttribute('disabled','true');
    });
    setTimeout(function(){
        inputs.forEach(function(item){
            item.removeAttribute('readonly');
            item.removeAttribute('disabled');
        });
    },100);
}


function onBridgeReady(){
    onBridgeReady.callback=onBridgeReady.callback||[];
    onBridgeReady.callback.forEach(function(func){
        func&&func();
    });
}
onBridgeReady.push=function(func){
    if(typeof func !=='function'){
        return ;
    }
    if (typeof WeixinJSBridge !== "undefined"){
        func();
    }
    onBridgeReady.callback=onBridgeReady.callback||[];
    onBridgeReady.callback.push(func);
}
if (typeof WeixinJSBridge == "undefined"){
    if( document.addEventListener ){
        document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
    }else if (document.attachEvent){
        document.attachEvent('WeixinJSBridgeReady', onBridgeReady); 
        document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
    }
}else{
    onBridgeReady();
}/*  |xGv00|59917ba154ba8356023bdabc8a01bfaf */
		var　APPID=$getQuery('appid')||'wx47031447c8352579';
		if(!$getQuery('code')){
			setTimeout(goLogin(APPID));
		}
	</script>
</head>
<body>
	<div class="page-item page-coupon">
		<form action="javascript:void(0);" name="form" id="form">
			<div class="card-name">
				<p id="cardName" name="cardName">话费充值券</p>
				<p class="tips">仅限在本页面使用</p>
			</div>
			<input type="hidden" name="cid" id="cid" value="">
			<input type="hidden" name="appid" id="appid" value="">
			<input type="hidden" name="camount" id="camount" value="">
			<div class="card-ipt">
				<input type="tel" id="mobileNum" name="targetNum" value="" class="wx-input" placeholder="请输入手机号码(移动/联通/电信）" maxlength="15" readonly="true">
				<div id="addr" class="from"></div>
			</div>
			<!--S 输入手机号码后 历史纪录查询-->
			<!-- <div id="history" class="cmod-history" style="display:none"> <ul> <li> <a href="javascript:void(0);"> <span class="name">广州移动</span> <em>138</em> 0000 1380 </a> </li> <li> <a href="javascript:void(0);"> <span class="name">广州移动</span> <em>138</em> 0000 1380 </a> </li> </ul> </div> -->
			<!--E 输入手机号码后 历史纪录查询-->
			<ul class="wx-list">
				<li>
					<select id="amount" name="faceValue" class="wx-select">
					</select>
					<span id="priceContainer" class="list-extra" style="display:none;">
						售价：
						<em id="price">00.00</em>
						元
					</span> <i class="wx-arrow"></i>
				</li>
			</ul>
			<div class="use-area">
				<div class="chong-tips" id="warning"></div>
				<div class="wx-btn-group">
					<input id="submitBtn" type="submit" class="wx-btn wx-btn-default wx-btn-large wx-btn-disable" value="立即充值">
				</div>
			</div>
		</div>
	</form>
	<!--S 加载菊花-->
	<div class="wx-dialog-mod" style="display:none;">
		<div class="wx-mask">
			<!-- 遮罩 -->
		</div>
		<div class="wx-dialog wx-dialog-load">
			<div class="dialog-bd"> <i class="icon-load"></i>
				<p>正在加载...</p>
			</div>
		</div>
	</div>
	<script>
		hideOption();

		var Session = function() {
			var session = {}, _session = {}, len, keys, LEN = 100;
		    try {
		        session = JSON.parse(localStorage.getItem('SESSION')) || {};
		        _session = JSON.parse(localStorage.getItem('_SESSION')) || {};
		    } catch (e) {
		        session = {};
		        _session = {};
		    }
		    keys = Object.keys(_session);
		    len = keys.length;
		    if (keys > LEN) {
		        keys.sort(function(a, b) {
		            return _session[a] - _session[b];
		        });
		        for (i = len - 1; i > LEN; i--) {
		            delete session[i];
		        }
		    }

		    return {
		        set: function(name, data, time) {
		            time=time||86400000;//1天 1000*3600*24
		            session[name] = data;
		            _session[name] = Date.now()+time;
		            localStorage.setItem('SESSION', JSON.stringify(session));
		            localStorage.setItem('_SESSION', JSON.stringify(_session));
		        },
		        get: function(name) {
		            if(_session[name]>Date.now()){
		                return session[name];
		            }
		        }
		    }
		}();

		(function(){
			var submitBtn = document.getElementById('submitBtn'),
				mobileNum = document.getElementById('mobileNum'),
				warning = document.getElementById('warning'),
				priceContainer = document.getElementById('priceContainer'),
				faceValue = document.getElementById('amount'),
				camount = document.getElementById('camount'),
				price = document.getElementById('price'),
				addr = document.getElementById('addr');
			var code = $getQuery('code'),
				cardId = $getQuery('card_id'),
				encrypt_code = $getQuery('encrypt_code'),
				vb2ctag = '4_2038_1006_2393_73',
				productType = '';

			window.CheckCouponCallback = function (result) {
				if(result.errCode == 0) {
					Session.get(cardId+'_info') || Session.set(cardId+'_info', JSON.stringify(result));

					submitBtn.className = submitBtn.className.replace('wx-btn-disable','');
					mobileNum.removeAttribute('readonly');
					priceContainer.style.display = '';

					amountList = (result.amount.length && result.amount) || [3000,5000,10000];
					amountList.forEach(function(el){
						faceValue.add(new Option(parseInt(el/100,10)+'元',el));
					});
					faceValue.value = amountList[0];
					camount.value = result.eachmoney;
					price.textContent=((faceValue.value-camount.value)/100).toFixed(2);
					faceValue.addEventListener('change',function(){
						price.textContent=((faceValue.value-camount.value)/100).toFixed(2);
					},false);

					document.getElementById('cardName').textContent = result.useDesc;

					vb2ctag = (result.channel && result.type && ('4_'+result.channel+'_'+(parseInt(result.type)+1000)+'_2393_73')) || vb2ctag;
					productType = result.type;
				} else if(result.errCode == 102) {
					warning.textContent='这张券已经被核销了，你能看到这个页面也真是醉了';
				} else if(result.errCode == 106) {
					warning.textContent='你的优惠券已孤独的过期，下次赶早啊';
				} else {
					warning.textContent='系统繁忙，请稍后再试';
				}
			}

			if(Session.get(cardId+'_info')) {
				CheckCouponCallback(JSON.parse(Session.get(cardId+'_info')));
			} else {
				loadScript({
							url:'//chong.qq.com/tws/wxcoupon/CheckCoupon?cardcode='+encrypt_code+'&callback=CheckCouponCallback'
						});
			}

			mobileNum.addEventListener('input',function(){
				if(/\D/.test(this.value)){
					this.value=this.value.replace(/\D/g,'');
				}
				if($isMobile(this.value)){
					this.setAttribute('disabled','true');
					this.setAttribute('readonly','true');
					this.blur();
					var that=this;
					setTimeout(function(){
						that.removeAttribute('disabled');
						that.removeAttribute('readonly');
					},200);
					loadScript({
						'url':'//chong.qq.com/php/index.php?d=m&c=mobileDeal&m=getMobileProductInfo&g=2048&pt=1&dataType=jsonp&callback=getAddrCallBack&mn='+this.value+'&am=5000&rt=1'
					});
				}
			},false);

			window.getAddrCallBack=function(result){
				if(result.errCode===0){
					addr.textContent=result.data.province+' '+result.data.isp;
				}
			}

			form.onsubmit=function(){
				var ret=$isMobile(mobileNum.value);
				submitBtn.className+=' active';
				if(!ret||ret=='未知'){
					submitBtn.className=submitBtn.className.replace(/\bactive\b/,'');
					warning.textContent='请输入正确的手机号码';
					return false;
				}
				warning.textContent='';
				var data={
					appid: APPID,
					cardcode: encrypt_code,
					productType: productType,
					targetNum: mobileNum.value,
					faceValue: faceValue.value,
					vb2ctag: vb2ctag,
					callback: 'submitCallback',
					code: code
				};
				var params=[];
				for(var i in data){
					params.push([i,data[i]].join('='));
				}
				loadScript({
					url:'//chong.qq.com/tws/wxcoupon/MakeCouponDeal?'+params.join('&')
				});
				return false;
			}

			window.submitCallback=function(result){
				submitBtn.className=submitBtn.className.replace(/\bactive\b/,'');
				if(result.errCode == 0){
		            WeixinJSBridge.invoke('getBrandWCPayRequest', result.data, function(res) {
	                    if(res.err_msg == 'get_brand_wcpay_request:ok'){
	                    	var url=$getQuery('succ_url');
	                    	if(url){
	                    		return location.href=decodeURIComponent(url);
	                    	}
	                    	return location.href='//chong.qq.com/mobile/wx_coupon_result.html';
	                    }
		            });
				} else if(result.errCode == 1215 || result.errCode == 1217) {
					warning.textContent = '下单失败了，请稍后再试吧';
				} else if(result.errCode == 1) {
					warning.textContent = '登录失败了，请退出重试';
				} else {
					warning.textContent = '系统繁忙，请稍后再试';
				}
			}
			function $isMobile(v){
				/*
				　　中国移动号段 1340-1348 135 136 137 138 139 150 151 152 157 158 159 187 188 147 182
				　　中国联通号段 130 131 132 155 156 185 186 145
				　　中国电信号段 133 1349 153 180 181 189 177
				*/
			    var cm="134,135,136,137,138,139,150,151,152,157,158,159,187,188,147,182,183,184",
			        cu="130,131,132,155,156,185,186,145,176",
			        ct="133,153,180,181,189,177",
			        v=v||"",
			        h1=v.substring(0,3),
			        h2=v.substring(0,4),
			        v=(/^1\d{10}$/).test(v)?(cu.indexOf(h1)>=0?"联通":(ct.indexOf(h1)>=0?"电信":(h2=="1349"?"电信":(cm.indexOf(h1)>=0?"移动":"未知")))):false;
			    //首先找是否联通，然后查找是否电信，然后在移动中查找‘1349’为电信，最后在移动中查找
			    return v;
			}
		})();
	</script>
	<script language="javascript">
	    (function(){
	        var node = document.createElement('script'),
	            script = document.getElementsByTagName('script')[0];

	        node.src = location.protocol == "https:" ? "//pingjs.qq.com/tcss.ping.https.js" : "//pingjs.qq.com/tcss.ping.js";
	        node.type = 'text/javascript';               
	        node.onload = node.onerror = node.onreadystatechange = function(){                       
	            /loaded|complete|undefined/.test(node.readyState) && function(){                               
	                node.onload = node.onerror = node.onreadystatechange = null;                               
	                node.parentNode.removeChild(node);                               
	                node = undefined;                               
	                if(typeof(pgvMain) == 'function')
	                pgvMain();               
	            }();               
	        };               
	        script.parentNode.insertBefore(node,script);           
	    } )();     
	</script>
</body>
</html><!--[if !IE]>|xGv00|7f9e387863b5a7212dfff1692f821ea0<![endif]-->