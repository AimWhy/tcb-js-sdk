<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="format-detection" content="telephone=no"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta content="telephone=no" name="format-detection"/>
  <title>测试页面</title>
  <script src="tcb-js-sdk.js"></script>
  <script>
    let successCallback = function (res) {
        try {
          console.assert(!res.code, res)
        } catch (e) {
          console.assert(false, res)
        }
      },
      errorCallback = function (err) {
        console.assert(false, err)
      },
      assert = function (messageObj, err, res) {
        let bool;
        if (arguments.length === 3) {
          bool = !(!err || err.code || err instanceof Error || res.code);
        } else if (arguments.length === 2) {
          bool = !(!err || err.code || err instanceof Error);
        } else {
          bool = false;
        }

        if (bool) {
          console.log('test passed', messageObj, err, res);
        } else {
          console.assert(false, messageObj, err, res);
        }
      };

    // init storage
    let fileIdList = [];
    let uploadFile = async function (app) {
      app.uploadFile({
        filePath: document.getElementById('file').files[0],
        cloudPath: 'test',
        onUploadProgress: (response) => {
          console.log(response);
        }
      }, function (err, res) {
        assert({method: 'storage:uploadFile', returnType: 'callback'}, err, res);
      });
      await app.uploadFile({
        filePath: document.getElementById('file').files[0],
        cloudPath: 'test',
        onUploadProgress: (response) => {
          console.log(response);
        }
      }).then(function (err, res) {
        assert({method: 'storage:uploadFile', returnType: 'promise'}, err, res);
      }).catch(function (err) {
        console.assert(false, {method: 'storage:uploadFile', returnType: 'promise'}, err);
      });
    };
    let getTempFileURL = async function (app) {
      if (!fileIdList.length) {
        alert("Please upload file first.");
        return;
      }

      app.getTempFileURL({
        fileList: fileIdList
      }).then(function (err, res) {
        if (err === 0 && !res.code) {
          successCallback(res);
        } else {
          errorCallback(err);
        }
      }).catch(errorCallback);
      app.getTempFileURL({
        fileList: fileIdList.map(fileId => {
          return {
            fileId,
            maxAge: 600
          }
        })
      }).then(function (err, res) {
        if (err === 0 && !res.code) {
          successCallback(res);
        } else {
          errorCallback(err);
        }
      }).catch(errorCallback);
    };
    let downloadFile = async function (app) {
      if (!fileIdList.length) {
        alert("Please upload file first.");
        return;
      }
      if (fileIdList.length > 1) {
        console.log("Only the first file will be downloaded.")
      }

      app.downloadFile({
        fileId: fileIdList[0]
      })
    };
    let deleteFile = async function (app) {
      if (!fileIdList.length) {
        alert("Please upload file first.");
        return;
      }

      app.deleteFile({
        fileList: fileIdList
      }).then(function (err, res) {
        if (err === 0 && !res.code) {
          successCallback(res);

          fileIdList = [];
          document.getElementById("fileId").innerText = "";
        } else {
          errorCallback(err);
        }
      }).catch(errorCallback)
    };

    let app;
    let init = async function () {
      // 初始化
      app = tcb.init({
        appid: 'wxacfb81f2ced64e70',
        //env: 'ianhu',
        env: 'sdf3-1c45e7'
      });

      await test_auth(app);

      await test_function(app);

      await test_database(app);
    };

    // auth
    let test_auth = async function (app) {
      let auth = app.auth(),
        AllowedScopes = ['snsapi_base', 'snsapi_userinfo', 'snsapi_login'],
        i,
        scope;

      for (i = 0; i < AllowedScopes.length; i++) {
        scope = AllowedScopes[i];

        auth.weixinAuthProvider({scope: scope}).signIn((res) => {
          assert({method: 'auth:signIn', returnType: 'callback', scope: scope}, res);
        });
        await auth.weixinAuthProvider({scope: scope}).signIn().then(function (res) {
          assert({method: 'auth:signIn', returnType: 'promise', scope: scope}, res);
        }).catch(function (err) {
          console.assert(false, {method: 'auth:signIn', returnType: 'promise', scope: scope}, err, res);
        });

        await auth.getUserInfo().then(function (err, res) {
          assert({method: 'auth:getUserInfo', returnType: 'promise', scope: scope}, err, res);
        }).catch(function (err) {
          console.assert(false, {method: 'auth:getUserInfo', returnType: 'promise', scope: scope}, err);
        });
      }
    };

    // function
    let test_function = async function (app) {
      app.callFunction({name: 'test', data: {hello: 'world'}}, function (err, res) {
        assert({method: 'function:callFunction', returnType: 'callback'}, err, res);
      });
      await app.callFunction({name: 'test', data: {hello: 'world'}}).then(function (err, res) {
        assert({method: 'function:callFunction', returnType: 'promise'}, err, res);
      }).catch(function (err) {
        console.assert(false, {method: 'function:callFunction', returnType: 'promise'}, err);
      });
    };
  </script>
  <script type="text/javascript">
    // database
    let test_database = async function (app) {
      // 获取数据库饮用
      let db = app.database();
      // 获取集合引用
      let coll = db.collection('coll-1');
      console.log({method: 'database:collection:name'}, coll.name);
      console.log({method: 'database:collection:doc'}, coll.doc());

      // 添加document
      coll.add({a: 1}, (err, res) => {
        assert({method: 'database:collection:add', returnType: 'callback'}, err, res);
      });
      await coll.add({a: 1}).then(function (err, res) {
        assert({method: 'database:collection:add', returnType: 'promise'}, err, res);
      }).catch(function (err) {
        console.assert(false, {method: 'database:collection:add', returnType: 'promise'}, err);
      });
      // 更新document


    };
  </script>
  <script type="text/javascript">
    init();
  </script>
</head>

<body>
  <h1>file upload</h1>

  <form role="form" class="form" onsubmit="return false;">
    <div class="form-group">
      <label for="file">File</label>
      <input id="file" type="file" class="form-control"/>
    </div>
    <button id="uploadFile" type="button" class="btn btn-primary">uploadFile</button>
    <p>
      file id:
      <span id="fileId"></span>
    </p>
    <button id="getTempFileURL" type="button" class="btn btn-primary">getTempFileURL</button>
    <button id="downloadFile" type="button" class="btn btn-primary">downloadFile</button>
    <button id="deleteFile" type="button" class="btn btn-primary">deleteFile</button>
  </form>

  <div id="output" class="container"></div>
</body>
<script>
  document.getElementById('uploadFile').onclick = function () {
    uploadFile(app);
  };
  document.getElementById('getTempFileURL').onclick = function () {
    getTempFileURL(app);
  };
  document.getElementById('downloadFile').onclick = function () {
    downloadFile(app);
  };
  document.getElementById('deleteFile').onclick = function () {
    deleteFile(app);
  };
</script>

</html>